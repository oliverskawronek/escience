<h1><%= l(:label_user_messages_new) %></h1>

<% form_for(@user_message) do |f| %>
  <%#= f.error_messages %>
  <p>
    <%= f.label l(:label_user_messages_receiver) %><br />
    <div class="ui-widget" id="recipient_autocomplete">
    	<div id="log" class="ui-widget-content"></div>
    	<input id="user_message_receiver_visible" />
    	<%= f.hidden_field :receiver %>
    	<%= hidden_field_tag("buffer", @user_message_reply_id) %>
    	<%= hidden_field_tag("reply_mail", @user_message_reply_mail) %>
    </div>
  </p>
  <p>
    <%= f.label l(:label_user_messages_subject) %><br />
    <%= f.text_field :subject %>
  </p>
  <p>
    <%= f.label l(:label_user_messages_body) %><br />
    <%= f.text_area :body %>
  </p>
  <p>
    <%= f.submit l(:label_user_messages_send) %>
  </p>
<% end %>

<% content_for :header_tags do %>
  <%= stylesheet_link_tag 'user_message' %>
  <%= javascript_include_tag 'visualsearch/jquery.ui.core.js' %>
  <%= javascript_include_tag 'visualsearch/jquery.ui.position.js' %>
  <%= javascript_include_tag 'visualsearch/jquery.ui.widget.js' %>
  <%= javascript_include_tag 'visualsearch/jquery.ui.autocomplete.js' %>
  <%= javascript_include_tag 'visualsearch/underscore-1.1.5.js' %>
  <%= javascript_include_tag 'visualsearch/backbone-0.5.0.js' %>
  
  <%= javascript_tag '
  var $js = jQuery.noConflict();
	$js(function() {
		function log( message ) {
			var element = $js( "<div class=\'name_element element_"+$js("#buffer").val()+"\' />" ).text( message ).prependTo( "#log" );
			var delete_item = $js( "<div class=\'delete_button element_"+$js("#buffer").val()+"\' />" ).prependTo( element ).click(function(){
			 var id = $js(this).attr(\'class\').split(\' \')[1].substring(8);
			 var olddata_arr = $js("#user_message_receiver").val().split(\',\');
			 if (olddata_arr.length == 0) {
			   $js("#user_message_receiver").val("");
			 } else {
  			 olddata_arr.splice($js.inArray(id, olddata_arr), 1 );
  			 $js("#user_message_receiver").val(olddata_arr.join(\',\'));
  			 $js(this).parent().remove();
			 }
		  });
			$js( "#log" ).scrollTop( 0 );
			var olddata = $js("#user_message_receiver").val();
			if (olddata != "") olddata = olddata+","+$js("#buffer").val();
			else olddata = $js("#buffer").val();
			$js("#user_message_receiver").val(olddata);
			$js("#user_message_receiver_visible").val("");
		}

		$js( "#user_message_receiver_visible" ).autocomplete({
			source: function( request, response ) {
				$js.ajax({
					url: "'+url_for(:controller => "users", :action => "user_search")+'",
  				dataType: "json",
					data: {
						maxRows: 12,
						q: request.term
					},
					success: function( data ) {
						response( $js.map( data, function( item ) {
						  $js("#buffer").val(item.id);
							return {
								label: item.firstname + " " +item.lastname
							}
						}));
					}
				});
			},
			minLength: 2,
			select: function( event, ui ) {
				log(ui.item.label);
				return false;
			},
			open: function() {
				$js( this ).removeClass( "ui-corner-all" ).addClass( "ui-corner-top" );
			},
			close: function() {
				$js( this ).removeClass( "ui-corner-top" ).addClass( "ui-corner-all" );
			}
		});'+@user_message_reply+
'});
	      ' %>
<% end %>


<% content_for :sidebar_right do %>
  	<li><%= link_to l(:label_back), user_messages_path %></li>
<%end%>