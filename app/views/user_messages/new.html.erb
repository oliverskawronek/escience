<h1><%= l(:label_user_messages_new) %></h1>

<%= form_for(@user_message) do |f| %>
  <div style="top:-40px; position:relative;">
    <%= f.submit l(:label_user_messages_send) %>
    <%= link_to l(:button_cancel), request.referer, :class => "icon icon-history", :class => 'button' %>
  </div>
  <%#= f.error_messages %>
  <p>
    <%= f.label l(:label_user_messages_receiver) %><br />
    <div class="ui-widget ui-widget-content" id="recipient_autocomplete">
    	<input id="user_message_receiver_visible" />
    	<%= f.hidden_field :receiver %>
    	<%= hidden_field_tag("buffer", @user_message_reply_id) %>
    	<%= hidden_field_tag("reply_mail", @user_message_reply_mail) %>
    	<div class="clear">&nbsp;</div>
    </div>
  	<div class="clear"></div>
  </p>
  <p>
    <%= f.label l(:label_user_messages_subject) %><br />
    <%= f.text_field :subject %>
  </p>
  <p>
    <%= f.label l(:label_user_messages_body) %><br />
    <%= f.text_area :body, :class => 'ckeditor' %>
  </p>
  <p>
    <%= f.submit l(:label_user_messages_send) %>
    <%= link_to l(:button_cancel), user_messages_path, :class => "icon icon-history", :class => 'button' %>
  </p>
<% end %>

<% content_for :header_tags do %>
  <%= stylesheet_link_tag 'user_message' %>
  <%= javascript_include_tag 'visualsearch/jquery.ui.core.js' %>
  <%= javascript_include_tag 'visualsearch/jquery.ui.position.js' %>
  <%= javascript_include_tag 'visualsearch/jquery.ui.widget.js' %>
  <%= javascript_include_tag 'visualsearch/jquery.ui.autocomplete.js' %>
  <%= javascript_include_tag 'ckeditor/ckeditor.js' %>
  <%#= javascript_include_tag 'visualsearch/underscore-1.1.5.js' %>
  <%#= javascript_include_tag 'visualsearch/backbone-0.5.0.js' %>
  
  <%= javascript_tag '
  	$(function() {
		$( "#recipient_autocomplete" ).click(function() {
		  user_message_receiver_visible.focus();
		});
		
		$( "#user_message_receiver_visible" ).autocomplete({
			source: function( request, response ) {
				$.ajax({
					url: "/usersearch",
  				dataType: "json",
					data: {
						maxRows: 12,
						q: request.term
					},
					success: function( data ) {
						response( $.map( data, function( item ) {
							return {
							  id: item.user.id,
								label: item.user.firstname + " " +item.user.lastname
							}
						}));
					}
				});
			},
			minLength: 2,
			select: function( event, ui ) {
				addUserToReceivers(ui.item.label, ui.item.id);
				return false;
			},
			open: function() {
				$( this ).removeClass( "ui-corner-all" ).addClass( "ui-corner-top" );
			},
			close: function() {
				$( this ).removeClass( "ui-corner-top" ).addClass( "ui-corner-all" );
			}
		});'+@user_message_reply+
'});
	      ' %>
<% end %>

<%= render :partial => "user_message_side_menu"%>